<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>åš´æ ¼æ•¸ç¨ (Sudoku Strict)</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --board-bg: #fff;
            --line-color: #344861;      /* ç²—ç·š (æ·±è—) */
            --thin-border: #bdc3c7;     /* ç´°ç·š (åŠ æ·±ä¸€é»çš„ç°ï¼Œé¡¯ç¤ºæ›´æ¸…æ¥š) */
            --highlight-color: #e2ebf3;
            --selected-color: #bbdefb;
            --same-num-color: #cbf0f8;
            --error-color: #f7cfd6;
            --text-color: #344861;
            --filled-color: #0072e3;
            --fixed-color: #000;
            --note-color: #7f8c8d;
            --menu-bg: #ffffff;
            --overlay-bg: rgba(0, 0, 0, 0.5);
        }

        * { box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            margin: 0;
            height: 100vh;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            user-select: none;
            -webkit-user-select: none;
            touch-action: none;
        }
        @supports (height: 100dvh) {
            body { height: 100dvh; min-height: 100dvh; }
        }

        /* --- 1. é ‚éƒ¨å°èˆªåˆ— --- */
        .top-bar {
            height: 50px;
            width: 100%;
            background-color: #fff;
            display: grid;
            grid-template-columns: 50px 1fr 120px;
            align-items: center;
            padding: 0 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            z-index: 10;
        }

        .menu-btn {
            font-size: 24px;
            cursor: pointer;
            background: none; border: none;
            color: var(--text-color);
            justify-self: start;
            padding: 5px;
        }

        /* é›£åº¦æ¨™é¡Œ (å¯é»é¸) */
        .header-difficulty {
            text-align: center;
            font-size: 18px;
            font-weight: bold;
            color: var(--filled-color);
            cursor: pointer; /* æ‰‹å‹æ¸¸æ¨™ */
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            padding: 5px 10px;
            border-radius: 15px;
            transition: background 0.2s;
        }
        .header-difficulty:active {
            background-color: #f0f7ff;
        
        }

        .game-status {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            font-size: 16px;
            font-weight: bold;
            color: var(--text-color);
            font-variant-numeric: tabular-nums;
        }
        .mistake-counter.warning { color: #e74c3c; }

        /* --- 2. éŠæˆ²ä¸»å€åŸŸ (ä¿®æ­£ç‰ˆ) --- */
        .game-container {
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
            width: 100%;
        }

        #sudoku-board {
            display: grid;
            grid-template-columns: repeat(9, 1fr);
            width: 100%;
            max-width: 450px;
            max-height: calc(100vh - 160px); 
            aspect-ratio: 1 / 1; 
            background-color: var(--thin-border);
            /* å¤–æ¡†ï¼š3px å¯¦ç·š */
            border: 3px solid var(--line-color); 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            position: relative;
            /* ä½¿ç”¨ gap + èƒŒæ™¯è‰²ç•«ç´°ç·šï¼Œé¿å… Chrome å­åƒç´ æ¶ˆå¤± */
            gap: 1px; 
        }

        /* --- æ ¼ç·šçµ‚æ¥µä¿®å¾© (æ”¹ç”¨ gap ç•«ç´°ç·š) --- */
        .cell {
            background-color: var(--board-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            font-weight: 500;
            color: var(--fixed-color);
            cursor: pointer;
            position: relative;
            z-index: 1;
        }

        /* --- 3x3 ç²—ç·šï¼šä½¿ç”¨å½å…ƒç´ è¦†è“‹ç´°ç·š --- */
        /* å‚ç›´ç²—ç·š */
        .cell.border-right::after {
            content: '';
            position: absolute;
            top: 0; 
            right: -1px; /* ç¨å¾®å‘å³åç§»ä»¥è¦†è“‹åŸæœ¬çš„ 1px ç´°ç·š */
            width: 3px;  /* è¨­å®šç‚º 3px ç¢ºä¿å®Œå…¨è“‹ä½ç´°ç·š */
            height: 100%;
            background-color: var(--line-color);
            z-index: 5;
            pointer-events: none; /* è®“é»æ“Šç©¿é€ï¼Œé¿å…æ“‹ä½æ“ä½œ */
        }

        /* æ°´å¹³ç²—ç·š */
        .cell.border-bottom::before {
            content: '';
            position: absolute;
            bottom: -1px; /* ç¨å¾®å‘ä¸‹åç§»ä»¥è¦†è“‹åŸæœ¬çš„ 1px ç´°ç·š */
            left: 0;
            width: 100%;
            height: 3px; /* è¨­å®šç‚º 3px */
            background-color: var(--line-color);
            z-index: 5;
            pointer-events: none;
        }


        /* --- ç­†è¨˜èˆ‡ç‹€æ…‹ --- */
        .note-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: grid; grid-template-columns: repeat(3, 1fr); grid-template-rows: repeat(3, 1fr);
            pointer-events: none; 
        }
        .note-num {
            display: flex; justify-content: center; align-items: center;
            font-size: 8px; color: var(--note-color); font-weight: normal;
        }

        .cell.selected { background-color: var(--selected-color) !important; }
        .cell.same-number { background-color: var(--same-num-color) !important; }
        .cell.highlight { background-color: var(--highlight-color); }
        .cell.error { background-color: var(--error-color) !important; color: #e74c3c !important; }
        .cell.fixed { font-weight: bold; }
        .cell.user-input { color: var(--filled-color); }

        /* --- 3. åº•éƒ¨éµç›¤å€ --- */
        .bottom-controls {
            width: 100%;
            background-color: var(--bg-color);
            padding: 10px 10px calc(20px + env(safe-area-inset-bottom)) 10px;
            display: flex; flex-direction: column; align-items: center; z-index: 10;
        }
        .hint-text { font-size: 12px; color: #888; margin-bottom: 8px; text-align: center; }
        .numpad { display: grid; grid-template-columns: repeat(5, 1fr); gap: 6px; width: 100%; max-width: 500px; }
        .num-btn {
            background-color: white; border: 1px solid #c6d2df; border-radius: 8px; height: 52px;
            font-size: 24px; color: var(--filled-color); display: flex; justify-content: center; align-items: center;
            cursor: pointer; box-shadow: 0 2px 0 #dce3eb; transition: transform 0.1s; position: relative;
        }
        .num-btn.swiping { background-color: var(--filled-color); color: white; transform: translateY(6px); box-shadow: none; }

        /* --- 4. å´é‚Šé¸å–® --- */
        .side-menu-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: var(--overlay-bg); z-index: 99; opacity: 0; visibility: hidden; transition: opacity 0.3s;
        }
        .side-menu-overlay.active { opacity: 1; visibility: visible; }
        .side-menu {
            position: fixed; top: 0; left: -280px; width: 280px; height: 100%;
            background-color: var(--menu-bg); z-index: 100; box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            transition: left 0.3s cubic-bezier(0.4, 0, 0.2, 1); display: flex; flex-direction: column; padding: 20px; overflow-y: auto;
        }
        .side-menu.active { left: 0; }
        .menu-header { font-size: 22px; font-weight: bold; margin-bottom: 20px; color: var(--text-color); display: flex; justify-content: space-between; align-items: center; }
        .close-menu-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #888; }
        .menu-section { margin-bottom: 25px; }
        .menu-section h3 { font-size: 14px; color: #888; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .menu-diff-options { display: flex; flex-direction: column; gap: 8px; }
        .menu-diff-btn { padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: #fff; text-align: left; font-size: 16px; cursor: pointer; display: flex; justify-content: space-between; }
        .menu-diff-btn.active { border-color: var(--filled-color); background-color: #f0f7ff; color: var(--filled-color); font-weight: bold; }
        .menu-diff-btn.active::after { content: 'âœ“'; }
        .menu-actions { display: flex; flex-direction: column; gap: 10px; }
        .menu-action-btn { padding: 12px; border: none; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; text-align: center; background-color: #f0f2f5; color: var(--text-color); }
        .btn-primary { background-color: var(--filled-color); color: white; }
        .btn-save { color: #27ae60; background: #eafaf1; }
        .btn-load { color: #e67e22; background: #fef5e7; }
        .seed-info { font-size: 13px; color: #888; text-align: center; margin-top: auto; padding-top: 20px; cursor: pointer; text-decoration: underline; }

        /* Game Over & Toast */
        #game-over-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.9); display: none; flex-direction: column; justify-content: center; align-items: center; z-index: 20; }
        #game-over-overlay h2 { margin: 0 0 10px 0; color: #e74c3c; }
        #game-over-overlay button { padding: 10px 20px; background: var(--filled-color); color: white; border: none; border-radius: 5px; font-size: 16px; }
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 20px; padding: 10px; position: fixed; z-index: 200; left: 50%; bottom: 80px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: opacity 0.3s; }
        #toast.show { visibility: visible; opacity: 0.9; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 20% { transform: translate(-3px, 0px); } 40% { transform: translate(3px, 0px); } 60% { transform: translate(-3px, 0px); } 100% { transform: translate(0, 0); } }
        .shake-animation { animation: shake 0.4s; }
        @media (max-height: 600px) { .cell { font-size: 18px; } .num-btn { height: 45px; } .top-bar { height: 40px; } }
        @media (max-width: 600px) { .game-container { flex: 0 0 auto; } }
    </style>
<link rel="manifest" href="manifest.webmanifest">
<meta name="theme-color" content="#ffffff">
<meta name="apple-mobile-web-app-capable" content="yes">
</head>
<body>

    <div class="top-bar">
        <button class="menu-btn" onclick="toggleMenu()">â˜°</button>
        <div class="header-difficulty" id="header-diff-display" onclick="toggleMenu()">æ™®é€š</div>
        <div class="game-status">
            <span id="mistake-display" class="mistake-counter">0/3</span>
            <span id="timer">00:00</span>
        </div>
    </div>

    <div class="game-container">
        <div id="sudoku-board">
            <div id="game-over-overlay">
                <h2>éŠæˆ²çµæŸ</h2>
                <p>éŒ¯èª¤æ¬¡æ•¸éå¤šï¼</p>
                <button onclick="initGame()">å†è©¦ä¸€æ¬¡</button>
            </div>
        </div>
    </div>

    <div class="bottom-controls">
        <div class="hint-text">ğŸ’¡ é»æ“Šå¯«ç­†è¨˜ï¼Œä¸‹æ»‘å¡«æ•¸å­—</div>
        <div class="numpad" id="numpad">
            <div class="num-btn" data-num="1">1</div>
            <div class="num-btn" data-num="2">2</div>
            <div class="num-btn" data-num="3">3</div>
            <div class="num-btn" data-num="4">4</div>
            <div class="num-btn" data-num="5">5</div>
            <div class="num-btn" data-num="6">6</div>
            <div class="num-btn" data-num="7">7</div>
            <div class="num-btn" data-num="8">8</div>
            <div class="num-btn" data-num="9">9</div>
            <div class="num-btn" data-num="X" style="color: #e74c3c;">âœ•</div>
        </div>
    </div>

    <div class="side-menu-overlay" id="menu-overlay" onclick="closeMenu()"></div>
    <div class="side-menu" id="side-menu">
        <div class="menu-header">
            é¸å–®
            <button class="close-menu-btn" onclick="closeMenu()">âœ•</button>
        </div>

        <div class="menu-section">
            <h3>é›£åº¦é¸æ“‡</h3>
            <div class="menu-diff-options">
                <div class="menu-diff-btn" id="menu-btn-easy" onclick="setDifficulty('easy')">ç°¡å–®</div>
                <div class="menu-diff-btn active" id="menu-btn-medium" onclick="setDifficulty('medium')">æ™®é€š</div>
                <div class="menu-diff-btn" id="menu-btn-hard" onclick="setDifficulty('hard')">å›°é›£</div>
                <div class="menu-diff-btn" id="menu-btn-expert" onclick="setDifficulty('expert')">å°ˆå®¶</div>
            </div>
        </div>

        <div class="menu-section">
            <h3>éŠæˆ²æ“ä½œ</h3>
            <div class="menu-actions">
                <button class="menu-action-btn btn-primary" onclick="initGame(); closeMenu();">ï¼‹ æ–°éŠæˆ²</button>
                <button class="menu-action-btn" onclick="resetCurrentGame(); closeMenu();">â†º æœ¬å±€é‡ä¾†</button>
                <button class="menu-action-btn btn-save" onclick="manualSave(); closeMenu();">ğŸ’¾ ä¿å­˜é€²åº¦</button>
                <button class="menu-action-btn btn-load" onclick="manualLoad(); closeMenu();">ğŸ“‚ è®€å–é€²åº¦</button>
            </div>
        </div>

        <div class="menu-section">
            <h3>å…¶ä»–</h3>
            <div class="menu-actions">
                <button class="menu-action-btn" onclick="promptSeed(); closeMenu();">âœ è¼¸å…¥ç¨®å­ç¢¼</button>
            </div>
        </div>

        <div class="seed-info" onclick="copySeed()" id="seed-label">Seed: #----</div>
    </div>

    <div id="toast"></div>

    <script>
        // --- è®Šæ•¸ ---
        let board = [], solution = [], fixedMask = [], notes = [];
        let selectedCellIndex = null;
        let timerInterval, seconds = 0;
        let currentSeed = 0, rngState = 0;
        let mistakes = 0;
        const MAX_MISTAKES = 3;
        let isGameOver = false;
        let currentDifficulty = 'medium';
        const DIFFICULTY_HOLES = { 'easy': 30, 'medium': 40, 'hard': 50, 'expert': 58 };
        const DIFFICULTY_LABELS = { 'easy': 'ç°¡å–®', 'medium': 'æ™®é€š', 'hard': 'å›°é›£', 'expert': 'å°ˆå®¶' };
        const SAVE_KEY = 'sudoku_save_v2';

        function toggleMenu() {
            document.getElementById('side-menu').classList.toggle('active');
            document.getElementById('menu-overlay').classList.toggle('active');
        }
        function closeMenu() {
            document.getElementById('side-menu').classList.remove('active');
            document.getElementById('menu-overlay').classList.remove('active');
        }

        function seedRandom(seed) { rngState = seed; }
        function myRandom() {
            rngState = (rngState * 9301 + 49297) % 233280;
            return rngState / 233280.0;
        }

        function initGame(seedInput = null) {
            if(timerInterval) clearInterval(timerInterval);
            mistakes = 0; isGameOver = false; updateMistakeUI();
            document.getElementById('game-over-overlay').style.display = 'none';

            if (seedInput !== null) currentSeed = parseInt(seedInput);
            else currentSeed = Math.floor(Math.random() * 99999) + 1;
            
            seedRandom(currentSeed);
            document.getElementById('seed-label').innerText = `Seed: #${currentSeed} (è¤‡è£½)`;
            updateHeaderDifficulty();

            notes = Array.from({length: 81}, () => new Set());
            startTimer();
            generateBoard();
            renderBoard();
            selectedCellIndex = null;
            
            saveGame(true);
        }

        function saveGame(isAuto = false) {
            if (isGameOver) return;
            const saveData = {
                board, solution, fixedMask,
                notes: notes.map(set => Array.from(set)),
                mistakes, seconds, currentDifficulty, currentSeed
            };
            localStorage.setItem(SAVE_KEY, JSON.stringify(saveData));
            if (!isAuto) showToast("é€²åº¦å·²ä¿å­˜ï¼");
        }

        function loadGame() {
            const json = localStorage.getItem(SAVE_KEY);
            if (!json) { showToast("æ²’æœ‰å­˜æª”ï¼"); return; }
            try {
                const data = JSON.parse(json);
                board = data.board; solution = data.solution; fixedMask = data.fixedMask;
                notes = data.notes.map(arr => new Set(arr));
                mistakes = data.mistakes; seconds = data.seconds;
                currentDifficulty = data.currentDifficulty; currentSeed = data.currentSeed;

                updateDifficultyUI(currentDifficulty);
                updateHeaderDifficulty();
                document.getElementById('seed-label').innerText = `Seed: #${currentSeed} (è¤‡è£½)`;
                updateMistakeUI();
                clearInterval(timerInterval);
                startTimer();
                renderBoard();
                document.getElementById('game-over-overlay').style.display = 'none';
                showToast("é€²åº¦å·²è®€å–ï¼");
            } catch (e) { showToast("å­˜æª”æå£"); }
        }

        function manualSave() { saveGame(false); }
        function manualLoad() { if(confirm("ç¢ºå®šè®€å–èˆŠé€²åº¦ï¼Ÿ")) loadGame(); }

        function setDifficulty(level) {
            currentDifficulty = level;
            updateDifficultyUI(level);
            initGame();
        }

        function updateHeaderDifficulty() {
            const label = DIFFICULTY_LABELS[currentDifficulty] || 'æ™®é€š';
            document.getElementById('header-diff-display').innerHTML = `${label} &nbsp;â–¼`;
        }

        function updateDifficultyUI(level) {
            document.querySelectorAll('.menu-diff-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`menu-btn-${level}`).classList.add('active');
            closeMenu();
        }

        function resetCurrentGame() {
            if (!confirm('æ¸…ç©ºé‡ä¾†ï¼Ÿ')) return;
            mistakes = 0; updateMistakeUI();
            for (let i = 0; i < 81; i++) {
                if (!fixedMask[i]) { board[i] = 0; notes[i].clear(); }
            }
            saveGame(true); renderBoard();
            if (selectedCellIndex !== null) selectCell(selectedCellIndex);
        }

        function generateBoard() {
            solution = Array.from({ length: 81 }, () => 0);
            fillBoardRecursively(solution);
            board = [...solution];
            fixedMask = Array.from({ length: 81 }, () => true);
            let indices = Array.from({length: 81}, (_, i) => i);
            for (let i = indices.length - 1; i > 0; i--) {
                const j = Math.floor(myRandom() * (i + 1));
                [indices[i], indices[j]] = [indices[j], indices[i]];
            }
            let holes = DIFFICULTY_HOLES[currentDifficulty];
            for (let i = 0; i < 81 && holes > 0; i++) {
                let idx = indices[i];
                if (board[idx] !== 0) { board[idx] = 0; fixedMask[idx] = false; holes--; }
            }
        }

        function fillBoardRecursively(grid) {
            let emptyIndex = grid.indexOf(0);
            if (emptyIndex === -1) return true;
            let row = Math.floor(emptyIndex / 9), col = emptyIndex % 9;
            let nums = [1, 2, 3, 4, 5, 6, 7, 8, 9];
            for (let i = nums.length - 1; i > 0; i--) {
                const j = Math.floor(myRandom() * (i + 1));
                [nums[i], nums[j]] = [nums[j], nums[i]];
            }
            for (let num of nums) {
                if (isValid(grid, row, col, num)) {
                    grid[emptyIndex] = num;
                    if (fillBoardRecursively(grid)) return true;
                    grid[emptyIndex] = 0;
                }
            }
            return false;
        }

        function isValid(grid, row, col, num) {
            for (let i = 0; i < 9; i++) {
                if (grid[row * 9 + i] === num) return false;
                if (grid[i * 9 + col] === num) return false;
                let br = 3 * Math.floor(row / 3) + Math.floor(i / 3);
                let bc = 3 * Math.floor(col / 3) + (i % 3);
                if (grid[br * 9 + bc] === num) return false;
            }
            return true;
        }

        // --- æ¸²æŸ“ (Grid Line Fix) ---
        function renderBoard() {
            const container = document.getElementById('sudoku-board');
            const overlay = document.getElementById('game-over-overlay');
            container.innerHTML = ''; container.appendChild(overlay);

            board.forEach((num, index) => {
                const cell = document.createElement('div');
                cell.classList.add('cell');
                const col = index % 9, row = Math.floor(index / 9);
                
                // 3x3 ç²—ç·šï¼šä½¿ç”¨ JS æ·»åŠ  classï¼ŒCSS ä½¿ç”¨å½å…ƒç´ æ¸²æŸ“
                if (col === 2 || col === 5) cell.classList.add('border-right');
                if (row === 2 || row === 5) cell.classList.add('border-bottom');

                if (num !== 0) {
                    cell.textContent = num;
                    if (fixedMask[index]) cell.classList.add('fixed');
                    else {
                        cell.classList.add('user-input');
                        if (num !== solution[index]) cell.classList.add('error');
                    }
                } else if (notes[index].size > 0) {
                    const noteGrid = document.createElement('div');
                    noteGrid.classList.add('note-grid');
                    for (let n = 1; n <= 9; n++) {
                        const div = document.createElement('div');
                        div.className = 'note-num';
                        if (notes[index].has(n)) div.textContent = n;
                        noteGrid.appendChild(div);
                    }
                    cell.appendChild(noteGrid);
                }
                cell.onclick = () => selectCell(index);
                container.appendChild(cell);
            });
        }

        function selectCell(index) {
            if (isGameOver) return;
            selectedCellIndex = index;
            const cells = document.querySelectorAll('.cell');
            const val = board[index];
            cells.forEach(c => c.classList.remove('selected', 'highlight', 'same-number'));
            cells[index].classList.add('selected');
            const r = Math.floor(index / 9), c = index % 9;
            cells.forEach((cell, i) => {
                const tr = Math.floor(i / 9), tc = i % 9;
                if (tr === r || tc === c) cell.classList.add('highlight');
                if (val !== 0 && board[i] === val) cell.classList.add('same-number');
            });
        }

        // --- äº’å‹• (Touch/Mouse) ---
        document.querySelectorAll('.num-btn').forEach(btn => {
            let startY = 0, isSwiping = false;
            let num = btn.dataset.num; if(num!=='X') num = parseInt(num);

            const start = (y) => { startY = y; isSwiping = false; };
            const move = (y, el) => {
                if((y - startY) > 25) { isSwiping = true; el.classList.add('swiping'); }
                else el.classList.remove('swiping');
            };
            const end = (el) => {
                el.classList.remove('swiping');
                if(isSwiping) fillRealNumber(num); else toggleNote(num);
            };

            btn.addEventListener('touchstart', e => { e.preventDefault(); start(e.touches[0].clientY); }, {passive:false});
            btn.addEventListener('touchmove', e => { e.preventDefault(); move(e.touches[0].clientY, btn); }, {passive:false});
            btn.addEventListener('touchend', e => end(btn));
            btn.addEventListener('mousedown', e => {
                start(e.clientY);
                const mm = ev => move(ev.clientY, btn);
                const mu = () => { document.removeEventListener('mousemove', mm); document.removeEventListener('mouseup', mu); end(btn); };
                document.addEventListener('mousemove', mm); document.addEventListener('mouseup', mu);
            });
        });

        function toggleNote(num) {
            if (isGameOver || selectedCellIndex === null || board[selectedCellIndex] !== 0 || fixedMask[selectedCellIndex]) return;
            if (num === 'X') notes[selectedCellIndex].clear();
            else {
                if (notes[selectedCellIndex].has(num)) notes[selectedCellIndex].delete(num);
                else notes[selectedCellIndex].add(num);
            }
            renderBoard(); selectCell(selectedCellIndex); saveGame(true);
        }

        function fillRealNumber(num) {
            if (isGameOver || selectedCellIndex === null || fixedMask[selectedCellIndex]) return;
            const cell = document.querySelectorAll('.cell')[selectedCellIndex];
            
            if (num === 'X') {
                board[selectedCellIndex] = 0; renderBoard(); selectCell(selectedCellIndex); saveGame(true); return;
            }

            if (num !== solution[selectedCellIndex]) {
                mistakes++; updateMistakeUI();
                cell.textContent = num; cell.classList.add('error', 'shake-animation');
                setTimeout(() => renderBoard(), 400);
                if (mistakes >= MAX_MISTAKES) triggerGameOver();
            } else {
                board[selectedCellIndex] = num;
                notes[selectedCellIndex].clear();
                cleanConflictingNotes(selectedCellIndex, num);
                renderBoard(); selectCell(selectedCellIndex); checkWin();
            }
            saveGame(true);
        }

        function cleanConflictingNotes(index, num) {
            const r = Math.floor(index / 9), c = index % 9;
            const sr = Math.floor(r / 3) * 3, sc = Math.floor(c / 3) * 3;
            for(let i=0; i<81; i++) {
                let tr = Math.floor(i / 9), tc = i % 9;
                if ((tr === r || tc === c || (tr >= sr && tr < sr+3 && tc >= sc && tc < sc+3)) && notes[i].has(num)) {
                    notes[i].delete(num);
                }
            }
        }

        function updateMistakeUI() {
            const el = document.getElementById('mistake-display');
            el.innerText = `éŒ¯èª¤: ${mistakes}/${MAX_MISTAKES}`;
            if(mistakes>=2) el.classList.add('warning'); else el.classList.remove('warning');
        }

        function triggerGameOver() {
            isGameOver = true; clearInterval(timerInterval);
            document.getElementById('game-over-overlay').style.display = 'flex';
        }

        function startTimer() {
            clearInterval(timerInterval);
            const update = () => {
                let m = Math.floor(seconds / 60).toString().padStart(2, '0');
                let s = (seconds % 60).toString().padStart(2, '0');
                document.getElementById('timer').innerText = `${m}:${s}`;
            };
            update();
            timerInterval = setInterval(() => { seconds++; update(); }, 1000);
        }

        function checkWin() {
            if (!board.includes(0) && board.every((v, i) => v === solution[i])) {
                clearInterval(timerInterval);
                setTimeout(() => alert(`æ­å–œï¼ç”¨æ™‚ï¼š${document.getElementById('timer').innerText}`), 100);
            }
        }

        function promptSeed() {
            const input = prompt("è¼¸å…¥ç¨®å­ç¢¼:");
            if (input) initGame(input);
        }
        function copySeed() { navigator.clipboard.writeText(currentSeed); showToast("ç¨®å­ç¢¼å·²è¤‡è£½"); }
        function showToast(msg) {
            const t = document.getElementById("toast"); t.innerText = msg; t.className = "show";
            setTimeout(() => t.className="", 2000);
        }

        document.addEventListener('keydown', e => {
            if (selectedCellIndex === null) return;
            const isNote = e.shiftKey;
            if (e.key >= '1' && e.key <= '9') {
                const n = parseInt(e.key);
                if (isNote) toggleNote(n); else fillRealNumber(n);
            }
            if (e.key === 'Backspace' || e.key === 'Delete') fillRealNumber('X');
        });

        // å•Ÿå‹•
        initGame();
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => { navigator.serviceWorker.register('./sw.js'); });
        }
    </script>
</body>
</html>
